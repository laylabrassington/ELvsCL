---
title: "GE_modeling_13nov25"
author: "layla"
date: "2025-11-19"
output: html_document
---

```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(magrittr)
library(EMMREML)
library(mashr)
library(metafor)
```


### 1. LMM with a GRM with everyone ---

```{r}
meta <- readRDS("~/vandy/early_life/redo_11nov25/modeling/meta_data_13nov25_AFTER_group_fixes.rds")
exp <- readRDS("~/vandy/early_life/redo_11nov25/modeling/exp_13nov25_batch_effects_removed.rds")
K <- readRDS("~/vandy/early_life/redo_11nov25/modeling/K_13nov25.rds")
```

make sure everything is in the same order
```{r}
identical(meta$sample_name,colnames(exp))
identical(meta$sample_name,colnames(K))
identical(colnames(exp),colnames(K))
```

```{r}
modSv = model.matrix(~urb_scale + early_scale + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("beta_", colnames(modSv)),
  paste0("sdev_", colnames(modSv)),
  paste0("p_value_", colnames(modSv))
)
res_full = as.data.frame(res_full)
rownames(res_full)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full
#saveRDS(res_full,file='~/vandy/early_life/redo_11nov25/modeling/lmm_grm_everyone_13nov25.rds')
```

### 2. LMM with a GRM with everyone and group category as a fixed effect  ---

```{r}
rm(list = ls())
```

```{r}
meta <- readRDS("~/vandy/early_life/redo_11nov25/modeling/meta_data_13nov25_AFTER_group_fixes.rds")
exp <- readRDS("~/vandy/early_life/redo_11nov25/modeling/exp_13nov25_batch_effects_removed.rds")
K <- readRDS("~/vandy/early_life/redo_11nov25/modeling/K_13nov25.rds")
```

make sure everything is in the same order
```{r}
identical(meta$sample_name,colnames(exp))
identical(meta$sample_name,colnames(K))
identical(colnames(exp),colnames(K))
```

```{r}
#ensure group is a factor 
meta$ethnicity_groups = as.factor(meta$ethnicity_groups)
meta$ethnicity_groups <- relevel(meta$ethnicity_groups, ref = "Other/Mixed")

modSv = model.matrix(~urb_scale + early_scale + age_scale + sex_medical + ethnicity_groups, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("beta_", colnames(modSv)),
  paste0("sdev_", colnames(modSv)),
  paste0("p_value_", colnames(modSv))
)
res_full = as.data.frame(res_full)
rownames(res_full)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full
#saveRDS(res_full,file='~/vandy/early_life/redo_11nov25/modeling/lmm_grm_evryne_grp_fixed_effect_13nov25.rds')
```




### 3. ancestry stratified (LMM with a GRM) ---


Proto-Malay 

```{r}
rm(list = ls())
```

```{r}
meta <- readRDS("~/vandy/early_life/redo_11nov25/modeling/meta_data_13nov25_AFTER_group_fixes.rds")
exp <- readRDS("~/vandy/early_life/redo_11nov25/modeling/exp_13nov25_batch_effects_removed.rds")
K <- readRDS("~/vandy/early_life/redo_11nov25/modeling/K_13nov25.rds")
```

```{r}
meta %<>% filter(ethnicity_groups=="Proto_Malay")
K=K[meta$sample_name, meta$sample_name]
exp=exp[,meta$sample_name]
```

```{r}
modSv = model.matrix(~urb_scale + early_scale + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("pm_beta_", colnames(modSv)),
  paste0("pm_sdev_", colnames(modSv)),
  paste0("pm_p_value_", colnames(modSv))
)
res_full_pm = as.data.frame(res_full)
rownames(res_full_pm)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full_pm[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full_pm
#saveRDS(res_full_pm,file='~/vandy/early_life/redo_11nov25/modeling/lmm_grm_pm_14nov25.rds')
```









Semang 

```{r}
rm(list = ls())
```

```{r}
meta <- readRDS("~/vandy/early_life/redo_11nov25/modeling/meta_data_13nov25_AFTER_group_fixes.rds")
exp <- readRDS("~/vandy/early_life/redo_11nov25/modeling/exp_13nov25_batch_effects_removed.rds")
K <- readRDS("~/vandy/early_life/redo_11nov25/modeling/K_13nov25.rds")
```

```{r}
meta %<>% filter(ethnicity_groups=="Semang")
K=K[meta$sample_name, meta$sample_name]
exp=exp[,meta$sample_name]
```

```{r}
modSv = model.matrix(~urb_scale + early_scale + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("sem_beta_", colnames(modSv)),
  paste0("sem_sdev_", colnames(modSv)),
  paste0("sem_p_value_", colnames(modSv))
)
res_full_sem = as.data.frame(res_full)
rownames(res_full_sem)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full_sem[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full_sem
#saveRDS(res_full_sem,file='~/vandy/early_life/redo_11nov25/modeling/lmm_grm_sem_14nov25.rds')
```









Senoi 

```{r}
rm(list = ls())
```

```{r}
meta <- readRDS("~/vandy/early_life/redo_11nov25/modeling/meta_data_13nov25_AFTER_group_fixes.rds")
exp <- readRDS("~/vandy/early_life/redo_11nov25/modeling/exp_13nov25_batch_effects_removed.rds")
K <- readRDS("~/vandy/early_life/redo_11nov25/modeling/K_13nov25.rds")
```

```{r}
meta %<>% filter(ethnicity_groups=="Senoi")
K=K[meta$sample_name, meta$sample_name]
exp=exp[,meta$sample_name]
```

```{r}
modSv = model.matrix(~urb_scale + early_scale + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("sen_beta_", colnames(modSv)),
  paste0("sen_sdev_", colnames(modSv)),
  paste0("sen_p_value_", colnames(modSv))
)
res_full_sen = as.data.frame(res_full)
rownames(res_full_sen)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full_sen[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full_sen
#saveRDS(res_full_sen,file='~/vandy/early_life/redo_11nov25/modeling/lmm_grm_sen_14nov25.rds')
```


### ancestry stratified directional ---

```{r}
rm(list = ls())
```

```{r}
semang <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_sem_14nov25.rds")
proto_malay <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_pm_14nov25.rds")
senoi <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_sen_14nov25.rds")
everyone <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_everyone_13nov25.rds")
```

```{r}
semang$gene = rownames(semang)
proto_malay$gene = rownames(proto_malay)
senoi$gene = rownames(senoi)
everyone$gene = rownames(everyone)

dfs <- list(everyone, senoi, proto_malay, semang)
merged_df <- Reduce(function(x, y) merge(x, y, by = "gene", all = TRUE), dfs)
```


```{r}
merged_df$every_urb = merged_df$beta_urb_scale
merged_df$every_early = merged_df$beta_early_scale
merged_df$every_age = merged_df$beta_age_scale
merged_df$every_sex = merged_df$beta_sex_medicalmale

merged_df$padj_urb = p.adjust(merged_df$p_value_urb_scale, method = "fdr")
merged_df$padj_early = p.adjust(merged_df$p_value_early_scale, method = "fdr")

#saveRDS(merged_df,file='~/vandy/early_life/redo_11nov25/modeling/group_stratified_14nov25.rds')

subset = merged_df %>% filter(padj_urb<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_urb, sen_beta_urb_scale, pm_beta_urb_scale, sem_beta_urb_scale), 1, function(x) all(x > 0) || all(x < 0))))
urb_genes = subset %>% filter(apply(dplyr::select(.,  every_urb, sen_beta_urb_scale, pm_beta_urb_scale, sem_beta_urb_scale), 1, function(x) all(x > 0) || all(x < 0)))

subset = merged_df %>% filter(padj_early<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_early, sen_beta_early_scale, pm_beta_early_scale, sem_beta_early_scale), 1, function(x) all(x > 0) || all(x < 0))))
early_genes = subset %>% filter(apply(dplyr::select(., every_early, sen_beta_early_scale, pm_beta_early_scale, sem_beta_early_scale), 1, function(x) all(x > 0) || all(x < 0)))

```


### comparing the two LMM with GRM (1 and 2) ---

```{r}
rm(list = ls())
```

```{r}
everyone <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_everyone_13nov25.rds")
everyone_fixed_effect <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_evryne_grp_fixed_effect_13nov25.rds")
```

```{r}
everyone$padj_urb = p.adjust(everyone$p_value_urb_scale, method = "fdr")
everyone$padj_early = p.adjust(everyone$p_value_early_scale, method = "fdr")

everyone_fixed_effect$padj_urb = p.adjust(everyone_fixed_effect$p_value_urb_scale, method = "fdr")
everyone_fixed_effect$padj_early = p.adjust(everyone_fixed_effect$p_value_early_scale, method = "fdr")
```

```{r}
dim(everyone %>% filter(padj_urb<0.1))
dim(everyone %>% filter(padj_early<0.1))

dim(everyone_fixed_effect %>% filter(padj_urb<0.1))
dim(everyone_fixed_effect %>% filter(padj_early<0.1))
```


### ancestry stratified, mashR ---


```{r}
set.seed(24)
```


urbanicty effects 

```{r}
rm(list = ls())
```

```{r}
model_out <- readRDS("~/vandy/early_life/redo_11nov25/modeling/group_stratified_14nov25.rds")
```

making the dfs for mashR
```{r}
coef <- as.data.frame(model_out %>% dplyr::select(sen_beta_urb_scale, pm_beta_urb_scale, sem_beta_urb_scale, gene))
rownames(coef) <- coef$gene
coef$gene = NULL
coef$sen_beta_urb_scale = as.numeric(coef$sen_beta_urb_scale)
coef$pm_beta_urb_scale = as.numeric(coef$pm_beta_urb_scale)
coef$sem_beta_urb_scale = as.numeric(coef$sem_beta_urb_scale)

se <- as.data.frame(model_out %>% dplyr::select(sen_sdev_urb_scale, pm_sdev_urb_scale, sem_sdev_urb_scale, gene))
rownames(se) <- se$gene
se$gene = NULL
se$sen_sdev_urb_scale = as.numeric(se$sen_sdev_urb_scale)
se$pm_sdev_urb_scale = as.numeric(se$pm_sdev_urb_scale)
se$sem_sdev_urb_scale = as.numeric(se$sem_sdev_urb_scale)

pvals = as.data.frame(model_out %>% dplyr::select(sen_p_value_urb_scale, pm_p_value_urb_scale, sem_p_value_urb_scale, gene))
pvals$sen_padj = p.adjust(pvals$sen_p_value_urb_scale, method = "fdr")
pvals$pm_padj = p.adjust(pvals$pm_p_value_urb_scale, method = "fdr")
pvals$sem_padj = p.adjust(pvals$sem_p_value_urb_scale, method = "fdr")


pvals = pvals %>% mutate(strength=ifelse(
  sen_padj < 0.1 | 
  pm_padj < 0.1 | 
  sem_padj < 0.1, "strong", "not"  
))

dim(pvals %>% filter(strength=="strong"))

stong_genes = pvals %>% filter(strength=="strong") %>% pull(gene)
```


removing negative se values 
```{r}
neg_rows <- se[apply(se, 1, function(x) any(x < 0)), ]
genes_to_remove = rownames(neg_rows)
se_filt = se[!(rownames(se) %in% genes_to_remove), ]
coef_filt = coef[!(rownames(coef) %in% genes_to_remove), ]
identical(rownames(coef_filt), rownames(se_filt))
new_strong = setdiff(stong_genes, genes_to_remove)
```

convert sdev to a standard error 
```{r}
se_filt$sen_sdev_urb_scale = sqrt(se_filt$sen_sdev_urb_scale)
se_filt$pm_sdev_urb_scale = sqrt(se_filt$pm_sdev_urb_scale)
se_filt$sem_sdev_urb_scale = sqrt(se_filt$sem_sdev_urb_scale)
```


```{r}
#make mash set for all sites
data.all = mash_set_data(as.matrix(coef_filt), as.matrix(se_filt))

#make subset of strong sites
data.strong = mash_set_data(as.matrix(coef[new_strong,]), as.matrix(se[new_strong,]))

# estimate correlations and update mash objects
# https://stephenslab.github.io/mashr/articles/intro_correlations.html

# needed more data to estimate the null correlations, the default of z_thresh = 2 was too low 
# z_thresh identifies rows where all Z-scores (Bhat / Shat) are below 2 in absolute value are treated as null
V.simple = estimate_null_correlation_simple(data.all)
data.all.cor = mash_update_data(data.all, V=V.simple)
data.strong.cor = mash_update_data(data.strong, V=V.simple)

# https://stephenslab.github.io/mashr/articles/intro_mash_dd.html
U.pca = cov_pca(data.strong.cor,2)
U.f = cov_flash(data.strong.cor)
U.ed = cov_ed(data.strong.cor, c(U.f, U.pca))
U.c = cov_canonical(data.all.cor)
m   = mash(data.all.cor, c(U.c,U.ed)) 
```

saving 
```{r}
#saveRDS(m,file='~/vandy/early_life/redo_11nov25/modeling/group_stratified_mash_URBresults_19nov25.rds')
```



early life effects 

```{r}
rm(list = ls())
```

```{r}
model_out <- readRDS("~/vandy/early_life/redo_11nov25/modeling/group_stratified_14nov25.rds")
```

making the dfs for mashR
```{r}
coef <- as.data.frame(model_out %>% dplyr::select(sen_beta_early_scale, pm_beta_early_scale, sem_beta_early_scale, gene))
rownames(coef) <- coef$gene
coef$gene = NULL
coef$sen_beta_early_scale = as.numeric(coef$sen_beta_early_scale)
coef$pm_beta_early_scale = as.numeric(coef$pm_beta_early_scale)
coef$sem_beta_early_scale = as.numeric(coef$sem_beta_early_scale)

se <- as.data.frame(model_out %>% dplyr::select(sen_sdev_early_scale, pm_sdev_early_scale, sem_sdev_early_scale, gene))
rownames(se) <- se$gene
se$gene = NULL
se$sen_sdev_early_scale = as.numeric(se$sen_sdev_early_scale)
se$pm_sdev_early_scale = as.numeric(se$pm_sdev_early_scale)
se$sem_sdev_early_scale = as.numeric(se$sem_sdev_early_scale)

pvals = as.data.frame(model_out %>% dplyr::select(sen_p_value_early_scale, pm_p_value_early_scale, sem_p_value_early_scale, gene))
pvals$sen_padj = p.adjust(pvals$sen_p_value_early_scale, method = "fdr")
pvals$pm_padj = p.adjust(pvals$pm_p_value_early_scale, method = "fdr")
pvals$sem_padj = p.adjust(pvals$sem_p_value_early_scale, method = "fdr")


pvals = pvals %>% mutate(strength=ifelse(
  sen_padj < 0.1 | 
  pm_padj < 0.1 | 
  sem_padj < 0.1, "strong", "not"  
))

dim(pvals %>% filter(strength=="strong"))

stong_genes = pvals %>% filter(strength=="strong") %>% pull(gene)
```


removing negative se values 
```{r}
neg_rows <- se[apply(se, 1, function(x) any(x < 0)), ]
genes_to_remove = rownames(neg_rows)
se_filt = se[!(rownames(se) %in% genes_to_remove), ]
coef_filt = coef[!(rownames(coef) %in% genes_to_remove), ]
identical(rownames(coef_filt), rownames(se_filt))
new_strong = setdiff(stong_genes, genes_to_remove)
```

convert sdev to a standard error 
```{r}
se_filt$sen_sdev_early_scale = sqrt(se_filt$sen_sdev_early_scale)
se_filt$pm_sdev_early_scale = sqrt(se_filt$pm_sdev_early_scale)
se_filt$sem_sdev_early_scale = sqrt(se_filt$sem_sdev_early_scale)
```


```{r}
#make mash set for all sites
data.all = mash_set_data(as.matrix(coef_filt), as.matrix(se_filt))

#make subset of strong sites
data.strong = mash_set_data(as.matrix(coef[new_strong,]), as.matrix(se[new_strong,]))

# estimate correlations and update mash objects
# https://stephenslab.github.io/mashr/articles/intro_correlations.html

# needed more data to estimate the null correlations, the default of z_thresh = 2 was too low 
# z_thresh identifies rows where all Z-scores (Bhat / Shat) are below 2 in absolute value are treated as null
V.simple = estimate_null_correlation_simple(data.all)
data.all.cor = mash_update_data(data.all, V=V.simple)
data.strong.cor = mash_update_data(data.strong, V=V.simple)

# https://stephenslab.github.io/mashr/articles/intro_mash_dd.html
U.pca = cov_pca(data.strong.cor,2)
U.f = cov_flash(data.strong.cor)
U.ed = cov_ed(data.strong.cor, c(U.f, U.pca))
U.c = cov_canonical(data.all.cor)
m   = mash(data.all.cor, c(U.c,U.ed)) 
```
saving 
```{r}
#saveRDS(m,file='~/vandy/early_life/redo_11nov25/modeling/group_stratified_mash_EARLYresults_19nov25.rds')
```




make matrix of lfsr and post means for both sets 

```{r}
rm(list = ls())
```

```{r}
urb <- readRDS("~/vandy/early_life/redo_11nov25/modeling/group_stratified_mash_URBresults_19nov25.rds")

#make lfsr and pm matricies
lfsr_mat <- get_lfsr(urb)
post_means <- get_pm(urb)

lfsr_mat <- data.frame(lfsr_mat)
lfsr_mat$sen_beta_urb_scale = as.numeric(lfsr_mat$sen_beta_urb_scale)
lfsr_mat$pm_beta_urb_scale = as.numeric(lfsr_mat$sem_beta_urb_scale)
lfsr_mat$sem_beta_urb_scale = as.numeric(lfsr_mat$sem_beta_urb_scale)
lfsr_mat = lfsr_mat %>% mutate(sig = if_else(if_any(c(sen_beta_urb_scale ,pm_beta_urb_scale , sem_beta_urb_scale), ~ .x < 0.1), 1, 0))

sig_rows <- rownames(lfsr_mat)[lfsr_mat[, "sig"] == 1]

post_means <- data.frame(post_means)
post_means$sen_beta_urb_scale  = as.numeric(post_means$sen_beta_urb_scale)
post_means$pm_beta_urb_scale = as.numeric(post_means$sem_beta_urb_scale)
post_means$sem_beta_urb_scale = as.numeric(post_means$sem_beta_urb_scale)

post_means_filt <- post_means[rownames(post_means) %in% sig_rows, ]

mag=2
post_means_filt <- post_means_filt %>%
  mutate(
    within2 = if_else(
      # sign agreement across all 3 beta columns
      sign(sen_beta_urb_scale) == sign(pm_beta_urb_scale) &
      sign(sen_beta_urb_scale) == sign(sem_beta_urb_scale) & 
      sign(pm_beta_urb_scale) == sign(sem_beta_urb_scale) &   
      
      # magnitude within factor "mag" for all pairwise comparisons
      abs(pm_beta_urb_scale) / abs(sen_beta_urb_scale) > 1/mag &
      abs(pm_beta_urb_scale) / abs(sen_beta_urb_scale) < mag &
      
      abs(sem_beta_urb_scale) / abs(sen_beta_urb_scale) > 1/mag &
      abs(sem_beta_urb_scale) / abs(sen_beta_urb_scale) < mag &
      
      abs(sem_beta_urb_scale) / abs(pm_beta_urb_scale) > 1/mag &
      abs(sem_beta_urb_scale) / abs(pm_beta_urb_scale) < mag,
      
      1, 0
    )
  )

table(post_means_filt$within2)    
```


save genes 
```{r}
shared = post_means_filt %>% filter(within2==1)
#saveRDS(shared,file='~/vandy/early_life/redo_11nov25/modeling/urb_shared_gene_set_19nov25.rds')
```






```{r}
rm(list = ls())
```

```{r}
early <- readRDS("~/vandy/early_life/redo_11nov25/modeling/group_stratified_mash_EARLYresults_19nov25.rds")

#make lfsr and pm matricies
lfsr_mat <- get_lfsr(early)
post_means <- get_pm(early)

lfsr_mat <- data.frame(lfsr_mat)
lfsr_mat$sen_beta_early_scale = as.numeric(lfsr_mat$sen_beta_early_scale)
lfsr_mat$pm_beta_early_scale = as.numeric(lfsr_mat$sem_beta_early_scale)
lfsr_mat$sem_beta_early_scale = as.numeric(lfsr_mat$sem_beta_early_scale)
lfsr_mat = lfsr_mat %>% mutate(sig = if_else(if_any(c(sen_beta_early_scale ,pm_beta_early_scale, sem_beta_early_scale), ~ .x < 0.1), 1, 0))

sig_rows <- rownames(lfsr_mat)[lfsr_mat[, "sig"] == 1]

post_means <- data.frame(post_means)
post_means$sen_beta_early_scale  = as.numeric(post_means$sen_beta_early_scale)
post_means$pm_beta_early_scale = as.numeric(post_means$sem_beta_early_scale)
post_means$sem_beta_early_scale = as.numeric(post_means$sem_beta_early_scale)

post_means_filt <- post_means[rownames(post_means) %in% sig_rows, ]

mag=2
post_means_filt <- post_means_filt %>%
  mutate(
    within2 = if_else(
      # sign agreement across all 3 beta columns
      sign(sen_beta_early_scale) == sign(pm_beta_early_scale) &
      sign(sen_beta_early_scale) == sign(sem_beta_early_scale) &
      sign(pm_beta_early_scale) == sign(sem_beta_early_scale) & 
      
      # magnitude within factor "mag" for all pairwise comparisons
      abs(pm_beta_early_scale) / abs(sen_beta_early_scale) > 1/mag &
      abs(pm_beta_early_scale) / abs(sen_beta_early_scale) < mag &
      
      abs(sem_beta_early_scale) / abs(sen_beta_early_scale) > 1/mag &
      abs(sem_beta_early_scale) / abs(sen_beta_early_scale) < mag &
      
      abs(sem_beta_early_scale) / abs(pm_beta_early_scale) > 1/mag &
      abs(sem_beta_early_scale) / abs(pm_beta_early_scale) < mag,
      
      1, 0
    )
  )
    
table(post_means_filt$within2) 
```

save genes 
```{r}
shared = post_means_filt %>% filter(within2==1)
#saveRDS(shared,file='~/vandy/early_life/redo_11nov25/modeling/early_shared_gene_set_19nov25.rds')
```




### ancestry stratified, meta-analysis ---


urbanicity 

```{r}
rm(list = ls())
```

```{r}
model_out <- readRDS("~/vandy/early_life/redo_11nov25/modeling/group_stratified_14nov25.rds")
```

need to make df for metafor 
```{r}
beta_mat <- model_out %>%
  dplyr::select(sen_beta_urb_scale, pm_beta_urb_scale, sem_beta_urb_scale) %>%
  as.matrix()

se_mat <- model_out %>%
  dplyr::select(sen_sdev_urb_scale, pm_sdev_urb_scale, sem_sdev_urb_scale) %>%
  as.matrix()

genes <- model_out$gene
n_genes <- nrow(beta_mat)
```

pre-allocate results
```{r}
results <- data.frame(
  gene = genes,
  est = NA,
  se = NA,
  zval = NA,
  pval = NA,
  Q = NA,
  Q_pval = NA )
```

loop over genes
```{r}
for(i in 1:n_genes){
  yi <- beta_mat[i, ]   # effect estimates for this gene
  sei <- se_mat[i, ]    # standard errors

  # Random-effects meta-analysis
  ma <- rma.uni(yi = yi, sei = sei, method = "REML")

  results$est[i] <- ma$b
  results$se[i] <- ma$se
  results$zval[i] <- ma$zval
  results$pval[i] <- ma$pval
  results$Q[i] <- ma$QE
  results$Q_pval[i] <- ma$QEp
  
  #print(i)
}
```

picking Q cutoff
```{r}
quantile(results$Q, 0.25)
#plot(results$Q, results$pval, log="x", xlab="Q (hetergeneity)", ylab="Meta-analysis p-value")
#abline(v = quantile(results$Q, 0.25), col="red", lty=2)
```


filter for consistent significant genes across all models
```{r}
sig <- results %>% filter(pval < 0.05 & Q < 383.9348 )
#saveRDS(sig,file='~/vandy/early_life/redo_11nov25/modeling/meta_analysis_urb_sig_14nov25.rds')
#saveRDS(sig,file='~/vandy/early_life/redo_11nov25/modeling/meta_analysis_urb_sig_19nov25.rds')
```



early life

```{r}
rm(list = ls())
```

```{r}
model_out <- readRDS("~/vandy/early_life/redo_11nov25/modeling/group_stratified_14nov25.rds")
```

need to make df for metafor 
```{r}
beta_mat <- model_out %>%
  dplyr::select(sen_beta_early_scale, pm_beta_early_scale, sem_beta_early_scale) %>%
  as.matrix()

se_mat <- model_out %>%
  dplyr::select(sen_sdev_early_scale, pm_sdev_early_scale, sem_sdev_early_scale) %>%
  as.matrix()

genes <- model_out$gene
n_genes <- nrow(beta_mat)
```

pre-allocate results
```{r}
results <- data.frame(
  gene = genes,
  est = NA,
  se = NA,
  zval = NA,
  pval = NA,
  Q = NA,
  Q_pval = NA )
```

loop over genes
```{r}
for(i in 1:n_genes){
  yi <- beta_mat[i, ]   # effect estimates for this gene
  sei <- se_mat[i, ]    # standard errors

  # Random-effects meta-analysis
  ma <- rma.uni(yi = yi, sei = sei, method = "REML")

  results$est[i] <- ma$b
  results$se[i] <- ma$se
  results$zval[i] <- ma$zval
  results$pval[i] <- ma$pval
  results$Q[i] <- ma$QE
  results$Q_pval[i] <- ma$QEp
  
  #print(i)
}
```

picking Q cutoff
```{r}
quantile(results$Q, 0.25)
#plot(results$Q, results$pval, log="x", xlab="Q (hetergeneity)", ylab="Meta-analysis p-value")
#abline(v = quantile(results$Q, 0.25), col="red", lty=2)
```


filter for consistent significant genes across all models
```{r}
sig <- results %>% filter(pval < 0.05 & Q < 601.8503)
#saveRDS(sig,file='~/vandy/early_life/redo_11nov25/modeling/meta_analysis_early_sig_14nov25.rds')
#saveRDS(sig,file='~/vandy/early_life/redo_11nov25/modeling/meta_analysis_early_sig_19nov25.rds')
```







### comparing all gene sets ---


```{r}
rm(list = ls())
```

```{r}
model_out = readRDS("~/vandy/early_life/redo_11nov25/modeling/model_out_all_24june25.rds")
model_out$every_urb = model_out$`every_beta_as.numeric(scale(meta$urb_score.y))`
model_out$every_early = model_out$`every_beta_as.numeric(scale(meta$Early_urban_PC1))`
model_out$every_age = model_out$every_beta_age_scale
model_out$every_sex = model_out$every_beta_sex_medicalmale

model_out$padj_urb = p.adjust(model_out$`every_p_value_as.numeric(scale(meta$urb_score.y))`, method = "fdr")
model_out$padj_early = p.adjust(model_out$`every_p_value_as.numeric(scale(meta$Early_urban_PC1))`, method = "fdr")


subset = model_out %>% filter(padj_urb<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_urb, `sem_beta_as.numeric(scale(meta$urb_score.y))`, `sen_beta_as.numeric(scale(meta$urb_score.y))`, `pm_beta_as.numeric(scale(meta$urb_score.y))`), 1, function(x) all(x > 0) || all(x < 0))))
urb_genes_previous = subset %>% filter(apply(dplyr::select(., every_urb, `sem_beta_as.numeric(scale(meta$urb_score.y))`, `sen_beta_as.numeric(scale(meta$urb_score.y))`, `pm_beta_as.numeric(scale(meta$urb_score.y))`), 1, function(x) all(x > 0) || all(x < 0)))

subset = model_out %>% filter(padj_early<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_early, `sem_beta_as.numeric(scale(meta$Early_urban_PC1))`, `sen_beta_as.numeric(scale(meta$Early_urban_PC1))`, `pm_beta_as.numeric(scale(meta$Early_urban_PC1))`), 1, function(x) all(x > 0) || all(x < 0))))
early_genes_previous = subset %>% filter(apply(dplyr::select(., every_early, `sem_beta_as.numeric(scale(meta$Early_urban_PC1))`, `sen_beta_as.numeric(scale(meta$Early_urban_PC1))`, `pm_beta_as.numeric(scale(meta$Early_urban_PC1))`), 1, function(x) all(x > 0) || all(x < 0)))

rm(model_out)
rm(subset)

urb_genes_previous = urb_genes_previous$gene
early_genes_previous = early_genes_previous$gene
```



```{r}
group_stratified <- readRDS("~/vandy/early_life/redo_11nov25/modeling/group_stratified_14nov25.rds")
subset = group_stratified %>% filter(padj_urb<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_urb, sen_beta_urb_scale, pm_beta_urb_scale, sem_beta_urb_scale), 1, function(x) all(x > 0) || all(x < 0))))
urb_genes_gs = subset %>% filter(apply(dplyr::select(.,  every_urb, sen_beta_urb_scale, pm_beta_urb_scale, sem_beta_urb_scale), 1, function(x) all(x > 0) || all(x < 0)))

subset = group_stratified %>% filter(padj_early<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_early, sen_beta_early_scale, pm_beta_early_scale, sem_beta_early_scale), 1, function(x) all(x > 0) || all(x < 0))))
early_genes_gs = subset %>% filter(apply(dplyr::select(., every_early, sen_beta_early_scale, pm_beta_early_scale, sem_beta_early_scale), 1, function(x) all(x > 0) || all(x < 0)))

rm(group_stratified)
rm(subset)

urb_genes_gs = urb_genes_gs$gene
early_genes_gs = early_genes_gs$gene
```

```{r}
everyone <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_everyone_13nov25.rds")
everyone_fixed_effect <- readRDS("~/vandy/early_life/redo_11nov25/modeling/lmm_grm_evryne_grp_fixed_effect_13nov25.rds")

everyone$padj_urb = p.adjust(everyone$p_value_urb_scale, method = "fdr")
everyone$padj_early = p.adjust(everyone$p_value_early_scale, method = "fdr")

everyone_fixed_effect$padj_urb = p.adjust(everyone_fixed_effect$p_value_urb_scale, method = "fdr")
everyone_fixed_effect$padj_early = p.adjust(everyone_fixed_effect$p_value_early_scale, method = "fdr")

everyone_urb = everyone %>% filter(padj_urb<0.1)
everyone_early = everyone %>% filter(padj_early<0.1)

everyone_fixed_urb = everyone_fixed_effect %>% filter(padj_urb<0.1)
everyone_fixed_early = everyone_fixed_effect %>% filter(padj_early<0.1)

rm(everyone)
rm(everyone_fixed_effect)

everyone_urb = rownames(everyone_urb)
everyone_early = rownames(everyone_early)
everyone_fixed_urb = rownames(everyone_fixed_urb)
everyone_fixed_early = rownames(everyone_fixed_early)
```

```{r}
urb_sharing_gene_sets <- readRDS("~/vandy/early_life/redo_11nov25/modeling/urb_shared_gene_set_19nov25.rds")
early_sharing_gene_sets <- readRDS("~/vandy/early_life/redo_11nov25/modeling/early_shared_gene_set_19nov25.rds")

all_shared_urb = rownames(urb_sharing_gene_sets)
all_shared_early = rownames(early_sharing_gene_sets)

rm(urb_sharing_gene_sets)
rm(early_sharing_gene_sets)
```

```{r}
meta_analysis_urb <- readRDS("~/vandy/early_life/redo_11nov25/modeling/meta_analysis_urb_sig_19nov25.rds")
meta_analysis_early <- readRDS("~/vandy/early_life/redo_11nov25/modeling/meta_analysis_early_sig_19nov25.rds")

meta_analysis_urb = meta_analysis_urb$gene
meta_analysis_early = meta_analysis_early$gene
```


```{r}
urb_gene_lists <- list(
  list1 = urb_genes_previous, #previous gene list from group stratified analysis 
  list2 = urb_genes_gs, #new list from group stratified analysis
  list3 = everyone_urb, #just model with everyone 
  list4 = everyone_fixed_urb, #model with everyone and group as fixed effect
  list5 = all_shared_urb, #mashR genes shared across all 3 groups
  list6 = meta_analysis_urb) #meta analysis genes pval <0.05 & Q < 25%
```


```{r}
lists <- urb_gene_lists
n <- length(lists)

overlap_mat <- matrix(0, n, n)
rownames(overlap_mat) <- names(lists)
colnames(overlap_mat) <- names(lists)

for (i in 1:n) {
  for (j in 1:n) {
    overlap_mat[i, j] <- length(intersect(lists[[i]], lists[[j]]))
  }
}

overlap_mat
```

```{r}
pheatmap::pheatmap(
  overlap_mat,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  display_numbers = TRUE,
  main = "gene sharing across the 6 methods")
```



```{r}
early_gene_lists <- list(
  list1 = early_genes_previous, #previous gene list from group stratified analysis 
  list2 = early_genes_gs, #new list from group stratified analysis
  list3 = everyone_early, #just model with everyone 
  list4 = everyone_fixed_early, #model with everyone and group as fixed effect
  list5 = all_shared_early, #mashR genes shared across all 3 groups
  list6 = meta_analysis_early) #meta analysis genes pval <0.05 & Q < 25%
```


```{r}
lists <- early_gene_lists
n <- length(lists)

overlap_mat <- matrix(0, n, n)
rownames(overlap_mat) <- names(lists)
colnames(overlap_mat) <- names(lists)

for (i in 1:n) {
  for (j in 1:n) {
    overlap_mat[i, j] <- length(intersect(lists[[i]], lists[[j]]))
  }
}

overlap_mat
```

```{r}
midpoint <- 200
colors <- colorRampPalette(c( "steelblue", "firebrick"))(100)

min_val <- min(overlap_mat)
max_val <- max(overlap_mat)

epsilon <- 1e-6

breaks <- c(
  seq(min_val, midpoint - epsilon, length.out = 50),
  seq(midpoint + epsilon, max_val, length.out = 51))

pheatmap::pheatmap(
  overlap_mat,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  display_numbers = TRUE,
  color = colors,
  breaks = breaks,
  number_color = "white",
  main = "gene sharing across the 6 methods")
```





