---
title: "ancestry_ge_model_clean_19june25"
output: html_document
date: "2025-06-19"
---


```{r message=FALSE, warning=FALSE}
library(readr)
library(dplyr)
library(magrittr)
library(EMMREML)
```





Proto_Malay
----------------------------------------------------
```{r}
rm(list = ls())
```


```{r}
meta = readRDS("~/vandy/early_life/meta_6june25.rds")
K = readRDS("~/vandy/early_life/K_el_28may25.rds")
exp = readRDS("~/vandy/early_life/exp_el_28may25.rds")
```


```{r}
meta %<>% filter(ethnicity2=="Proto_Malay")
K=K[meta$sample_name, meta$sample_name]
exp=exp[,meta$sample_name]
```

```{r}
modSv = model.matrix(~as.numeric(scale(meta$urb_score.y)) + as.numeric(scale(meta$Early_urban_PC1)) + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("beta_", colnames(modSv)),
  paste0("sdev_", colnames(modSv)),
  paste0("p_value_", colnames(modSv))
)
res_full = as.data.frame(res_full)
rownames(res_full)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full
```




Semang
----------------------------------------------------
```{r}
rm(list = ls())
```


```{r}
meta = readRDS("~/vandy/early_life/meta_6june25.rds")
K = readRDS("~/vandy/early_life/K_el_28may25.rds")
exp = readRDS("~/vandy/early_life/exp_el_28may25.rds")
```


```{r}
meta %<>% filter(ethnicity2=="Semang")
K=K[meta$sample_name, meta$sample_name]
exp=exp[,meta$sample_name]
```

```{r}
modSv = model.matrix(~as.numeric(scale(meta$urb_score.y)) + as.numeric(scale(meta$Early_urban_PC1)) + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("beta_", colnames(modSv)),
  paste0("sdev_", colnames(modSv)),
  paste0("p_value_", colnames(modSv))
)
res_full = as.data.frame(res_full)
rownames(res_full)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full
```




Senoi
----------------------------------------------------
```{r}
rm(list = ls())
```


```{r}
meta = readRDS("~/vandy/early_life/meta_6june25.rds")
K = readRDS("~/vandy/early_life/K_el_28may25.rds")
exp = readRDS("~/vandy/early_life/exp_el_28may25.rds")
```


```{r}
meta %<>% filter(ethnicity2=="Senoi")
K=K[meta$sample_name, meta$sample_name]
exp=exp[,meta$sample_name]
```

```{r}
modSv = model.matrix(~as.numeric(scale(meta$urb_score.y)) + as.numeric(scale(meta$Early_urban_PC1)) + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("beta_", colnames(modSv)),
  paste0("sdev_", colnames(modSv)),
  paste0("p_value_", colnames(modSv))
)
res_full = as.data.frame(res_full)
rownames(res_full)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full
```



everyone 
----------------------------------------------------
```{r}
rm(list = ls())
```


```{r}
meta = readRDS("~/vandy/early_life/meta_6june25.rds")
K = readRDS("~/vandy/early_life/K_el_28may25.rds")
exp = readRDS("~/vandy/early_life/exp_el_28may25.rds")
```

```{r}
modSv = model.matrix(~as.numeric(scale(meta$urb_score.y)) + as.numeric(scale(meta$Early_urban_PC1)) + age_scale + sex_medical, data=meta)

Z <- matrix(0, nrow = length(rownames(K)), ncol = length(colnames(K)))
rownames(Z) <- rownames(K)
colnames(Z) <- colnames(K)

for (i in seq_along(rownames(Z))) {
  match_idx <- match(rownames(Z)[i], meta$sample_name)
  if (!is.na(match_idx)) {
    Z[i, match_idx] <- 1
  }
}

#Declare object res_full to store in it the model results: beta coefficients, standard deviations and p values
res_full = matrix(NA, nrow=nrow(exp), ncol=3 * ncol(modSv))
colnames(res_full) = c(
  paste0("beta_", colnames(modSv)),
  paste0("sdev_", colnames(modSv)),
  paste0("p_value_", colnames(modSv))
)
res_full = as.data.frame(res_full)
rownames(res_full)=rownames(exp)

#run the model and store results (need to run in console)
for(i in 1:nrow(exp))
{
  emma=emmreml(y=exp[i,],X=modSv,Z=as.matrix(Z),K=as.matrix(K),varbetahat=T,varuhat=T,PEVuhat=T,test=T)
  res_full[i,]=t(c(emma$betahat,emma$varbetahat,emma$pvalbeta[,"none"]))
  print(i)
}

#save res_full
```



getting "rural" and "urban" gene lists 

```{r}
pm_out <- readRDS("~/vandy/early_life/pm_out_6june25.rds")
sem_out <- readRDS("~/vandy/early_life/sem_out_6june25.rds")
sen_out <- readRDS("~/vandy/early_life/sen_out_6june25.rds")
everyone_out <- readRDS("~/vandy/early_life/everyone_6june25.rds")
```


```{r}
pm_out$padj_urb = p.adjust(pm_out$`p_value_as.numeric(scale(meta$urb_score.y))`, method = "fdr")
pm_out$padj_early = p.adjust(pm_out$`p_value_as.numeric(scale(meta$Early_urban_PC1))`, method = "fdr")

sem_out$padj_urb = p.adjust(sem_out$`p_value_as.numeric(scale(meta$urb_score.y))`, method = "fdr")
sem_out$padj_early = p.adjust(sem_out$`p_value_as.numeric(scale(meta$Early_urban_PC1))`, method = "fdr")

sen_out$padj_urb = p.adjust(sen_out$`p_value_as.numeric(scale(meta$urb_score.y))`, method = "fdr")
sen_out$padj_early = p.adjust(sen_out$`p_value_as.numeric(scale(meta$Early_urban_PC1))`, method = "fdr")

everyone_out$padj_urb = p.adjust(everyone_out$`p_value_as.numeric(scale(meta$urb_score.y))`, method = "fdr")
everyone_out$padj_early = p.adjust(everyone_out$`p_value_as.numeric(scale(meta$Early_urban_PC1))`, method = "fdr")
```


```{r}
pm_out$pm_urb = pm_out$`beta_as.numeric(scale(meta$urb_score.y))`/pm_out$`sdev_as.numeric(scale(meta$urb_score.y))`
pm_out$pm_early = pm_out$`beta_as.numeric(scale(meta$Early_urban_PC1))`/pm_out$`sdev_as.numeric(scale(meta$Early_urban_PC1))`
pm_out %<>% dplyr::select(pm_urb, pm_early)
pm_out$gene = rownames(pm_out)

sem_out$sem_urb = sem_out$`beta_as.numeric(scale(meta$urb_score.y))`/sem_out$`sdev_as.numeric(scale(meta$urb_score.y))`
sem_out$sem_early = sem_out$`beta_as.numeric(scale(meta$Early_urban_PC1))`/sem_out$`sdev_as.numeric(scale(meta$Early_urban_PC1))`
sem_out %<>% dplyr::select(sem_urb, sem_early)
sem_out$gene = rownames(sem_out)

sen_out$sen_urb = sen_out$`beta_as.numeric(scale(meta$urb_score.y))`/sen_out$`sdev_as.numeric(scale(meta$urb_score.y))`
sen_out$sen_early = sen_out$`beta_as.numeric(scale(meta$Early_urban_PC1))`/sen_out$`sdev_as.numeric(scale(meta$Early_urban_PC1))`
sen_out %<>% dplyr::select(sen_urb, sen_early)
sen_out$gene = rownames(sen_out)

everyone_out$every_urb = everyone_out$`beta_as.numeric(scale(meta$urb_score.y))`/everyone_out$`sdev_as.numeric(scale(meta$urb_score.y))`
everyone_out$every_early = everyone_out$`beta_as.numeric(scale(meta$Early_urban_PC1))`/everyone_out$`sdev_as.numeric(scale(meta$Early_urban_PC1))`
everyone_out %<>% dplyr::select(every_urb, every_early, padj_urb, padj_early)
everyone_out$gene = rownames(everyone_out)

all = left_join(everyone_out, sen_out)
all = left_join(all, sem_out)
all = left_join(all, pm_out)
```


```{r}
subset = all %>% filter(padj_urb<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_urb, sen_urb, sem_urb, pm_urb), 1, function(x) all(x > 0) || all(x < 0))))
urb_genes = subset %>% filter(apply(dplyr::select(., every_urb, sen_urb, sem_urb, pm_urb), 1, function(x) all(x > 0) || all(x < 0)))

subset = all %>% filter(padj_early<0.1)
dim(subset %>% filter(apply(dplyr::select(., every_early, sen_early, sem_early, pm_early), 1, function(x) all(x > 0) || all(x < 0))))
early_genes = subset %>% filter(apply(dplyr::select(., every_early, sen_early, sem_early, pm_early), 1, function(x) all(x > 0) || all(x < 0)))

#saved here 

matching_genes = intersect(urb_genes$gene, early_genes$gene)
urb_genes %>% filter(gene %in% matching_genes) %>% select(every_urb, every_early, gene)
```




GO erichment of "rural" and "urban" genes (same as how we did it before)

```{r message=FALSE, warning=FALSE}
library(clusterProfiler)
library(org.Hs.eg.db)
library(enrichplot)
organism = "org.Hs.eg.db"
library(organism, character.only = TRUE)
library(ggplot2)
```

```{r}
set.seed(24)
```

matching genes across ancestry groups urb>0
```{r}
test= subset(urb_genes, urb_genes$every_urb>0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```




matching genes across ancestry groups urb<0
```{r}
test= subset(urb_genes, urb_genes$every_urb<0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```



sig genes in everyone model urb>0
```{r}
test= subset(everyone_out, everyone_out$padj_urb<0.1 & everyone_out$every_urb>0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```




sig genes in everyone model urb>0
```{r}
test= subset(everyone_out, everyone_out$padj_urb<0.1 & everyone_out$every_urb<0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```









matching genes across ancestry groups early>0
```{r}
test= subset(early_genes, early_genes$every_early>0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```




matching genes across ancestry groups early<0
```{r}
test= subset(early_genes, early_genes$every_early<0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```



sig genes in everyone model early>0
```{r}
test= subset(everyone_out, everyone_out$padj_early<0.1 & everyone_out$every_early>0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```




sig genes in everyone model early>0
```{r}
test= subset(everyone_out, everyone_out$padj_early<0.1 & everyone_out$every_early<0)$gene
back<-everyone_out$gene

GO <- enrichGO(gene = test,
                      universe = back,
                      OrgDb = org.Hs.eg.db,
                      ont  = "BP", keyType = "SYMBOL",
                      pAdjustMethod = "none",
                      qvalueCutoff  = 1,minGSSize = 5, maxGSSize = 500,
                      readable = TRUE)


edo <- pairwise_termsim(GO)
emapplot(edo,showCategory = 15)
dotplot(GO, showCategory=10, font.size=10)
```



filtered version 
```{r}
filtered_df <- GO@result[GO@result$p.adjust < 0.1, ]

filtered_GO <- new("enrichResult",
                          result = filtered_df,
                          pvalueCutoff = 1,
                          pAdjustMethod = "BH",
                          qvalueCutoff = 1,
                          organism = "UNKNOWN", 
                          ontology = "BP",
                          gene = GO@gene,
                          universe = GO@universe,
                          geneSets = GO@geneSets,
                          keytype = "UNKNOWN",  
                          readable = TRUE)
edo <- pairwise_termsim(filtered_GO)
emapplot(edo, showCategory=10)
dotplot(GO, showCategory=10, font.size=10)
```

















